name: update-iptv

on:
  schedule:
    - cron: '0 0 * * *'  # 每天凌晨执行
  push:
    branches:
      - main
  workflow_dispatch:  # 手动触发

jobs:
  update-iptv:
    runs-on: ubuntu-latest
    steps:
      - name: Set up job
        uses: actions/checkout@v3

      - name: 检出仓库代码
        uses: actions/checkout@v3

      - name: 克隆完整的IPTV-API项目
        run: git clone https://github.com/yourusername/iptv-api.git .

      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 安装所有依赖
        run: pip install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

      - name: 配置订阅源
        run: |
          # 这里可以添加配置订阅源的命令
          echo "Configuring subscription sources..."

      - name: 运行IPTV-API生成源文件
        run: python main.py generate

      - name: 复制生成的文件到仓库根目录
        run: |
          cp output/iptv.m3u .
          ls -la

      - name: 推送更新到仓库
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add iptv.m3u
          git commit -m 'Update IPTV sources'
          git push

      - name: Post 设置Python环境
        run: echo "Python environment setup completed"

      - name: Post 检出仓库代码
        run: echo "Repository code checked out"

      - name: Complete job
        run: echo "IPTV update job completed"
